<!--
title: Untitled Page
description: 
published: true
date: 2023-06-02T02:50:08.188Z
tags: 
editor: ckeditor
dateCreated: 2023-06-02T02:47:56.733Z
-->

<p>#!/usr/bin/env python</p>
<p>&nbsp;</p>
<p>import os,sys</p>
<p>import math</p>
<p>import matplotlib</p>
<p>matplotlib.use('Agg')</p>
<p>import matplotlib.pyplot as plt</p>
<p>from pylab import *</p>
<p>from collections import defaultdict</p>
<p>&nbsp;</p>
<p>from lefse import *</p>
<p>from numpy import *</p>
<p>import argparse</p>
<p>import sys</p>
<p>reload(sys)</p>
<p>sys.setdefaultencoding('utf-8')</p>
<p>#colors = ['#CD79FF','#00BB57','#FE90C2','#FF7F00','#00B8E5','#F8766D','#BC9D00','#8086F9','#64A10E','#D00000','#FF00FF','#464E04','#930026','#4E0C66','#F34800','#049a0b','#c7475b','#B3B3B3','#A3FDFF','#E2D89E','#A5CFED','#f0301c','#2B8BC3','#FDA100','#54adf5','#CDD7E2','#9295C1',"#FF0000FF", "#FF9900FF", "#CCFF00FF", "#33FF00FF" ,"#00FF66FF", "#00FFFFFF" ,"#0066FFFF" ,"#3300FFFF","#CC00FFFF","#FF0099FF"]</p>
<p>colors = ['r','g','b','m','c','#ac790F','k','#CD79FF','#FE90C2','#FF7F00','#00B8E5','#BC9D00','#8086F9','#64A10E','#D00000','#FF00FF','#464E04','#930026','#4E0C66','#F34800','#049a0b','#c7475b','#B3B3B3','#A3FDFF','#E2D89E','#A5CFED','#f0301c','#2B8BC3','#FDA100','#54adf5','#CDD7E2','#9295C1',"#FF0000FF", "#FF9900FF", "#CCFF00FF", "#33FF00FF" ,"#00FF66FF", "#00FFFFFF" ,"#0066FFFF" ,"#3300FFFF","#CC00FFFF","#FF0099FF"]</p>
<p>&nbsp;</p>
<p>def read_params(args):</p>
<p>&nbsp; &nbsp;parser = argparse.ArgumentParser(description='Plot results')</p>
<p>&nbsp; &nbsp;parser.add_argument('input_file', metavar='INPUT_FILE', type=str, help="tab delimited input file")</p>
<p>&nbsp; &nbsp;parser.add_argument('output_file', metavar='OUTPUT_FILE', type=str, help="the file for the output image")</p>
<p>&nbsp; &nbsp;parser.add_argument('--feature_font_size', dest="feature_font_size", type=int, default=7, help="the file for the output image")</p>
<p>&nbsp; &nbsp;parser.add_argument('--format', dest="format", choices=["png","svg","pdf"], default='png', type=str, help="the format for the output file")</p>
<p>&nbsp; &nbsp;parser.add_argument('--dpi',dest="dpi", type=int, default=72)</p>
<p>&nbsp; &nbsp;parser.add_argument('--title',dest="title", type=str, default="")</p>
<p>&nbsp; &nbsp;parser.add_argument('--title_font_size',dest="title_font_size", type=str, default="10")</p>
<p>&nbsp; &nbsp;parser.add_argument('--class_legend_font_size',dest="class_legend_font_size", type=str, default="6")</p>
<p>&nbsp; &nbsp;parser.add_argument('--width',dest="width", type=float, default=9.0 )</p>
<p>&nbsp; &nbsp;parser.add_argument('--height',dest="height", type=float, default=4.0, help="only for vertical histograms")</p>
<p>&nbsp; &nbsp;parser.add_argument('--left_space',dest="ls", type=float, default=0.2 )</p>
<p>&nbsp; &nbsp;parser.add_argument('--right_space',dest="rs", type=float, default=0.1 )</p>
<p>&nbsp; &nbsp;parser.add_argument('--orientation',dest="orientation", type=str, choices=["h","v"], default="h" )</p>
<p>&nbsp; &nbsp;parser.add_argument('--autoscale',dest="autoscale", type=int, choices=[0,1], default=1 )</p>
<p>&nbsp; &nbsp;parser.add_argument('--background_color',dest="back_color", type=str, choices=["k","w"], default="w", help="set the color of the background")</p>
<p>&nbsp; &nbsp;parser.add_argument('--subclades', dest="n_scl", type=int, default=1, help="number of label levels to be dislayed (starting from the leaves, -1 means all the levels, 1 is default )")</p>
<p>&nbsp; &nbsp;parser.add_argument('--max_feature_len', dest="max_feature_len", type=int, default=60, help="Maximum length of feature strings (def 60)")</p>
<p>&nbsp; &nbsp;parser.add_argument('--all_feats', dest="all_feats", type=str, default="")</p>
<p>&nbsp; &nbsp;parser.add_argument('--otu_only', dest="otu_only", default=False, action='store_true', help="Plot only species resolved OTUs (as opposed to all levels)")</p>
<p>&nbsp; &nbsp;parser.add_argument('--report_features', dest="report_features", default=False, action='store_true', help="Report important features to STDOUT")</p>
<p>&nbsp; &nbsp;args = parser.parse_args()</p>
<p>&nbsp; &nbsp;return vars(args)</p>
<p>&nbsp;</p>
<p>def read_data(input_file,output_file,otu_only):</p>
<p>&nbsp; &nbsp;with open(input_file, 'r') as inp:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;if not otu_only:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rows = [line.strip().split()[:-1] for line in inp.readlines() if len(line.strip().split())&gt;3]</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;else:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rows = [line.strip().split()[:-1] for line in inp.readlines() if len(line.strip().split())&gt;3 and len(line.strip().split()[0].split('.'))==8] # a feature with length 8 will have an OTU id associated with it</p>
<p>&nbsp; &nbsp;classes = list(set([v[2] for v in rows if len(v)&gt;2]))</p>
<p>&nbsp; &nbsp;if len(classes) &lt; 1: &nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;print "No differentially abundant features found in "+input_file</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;os.system("touch "+output_file)</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;sys.exit()</p>
<p>&nbsp; &nbsp;data = {}</p>
<p>&nbsp; &nbsp;data['rows'] = rows</p>
<p>&nbsp; &nbsp;data['cls'] = classes</p>
<p>&nbsp; &nbsp;return data</p>
<p>&nbsp;</p>
<p>def plot_histo_hor(path,params,data,bcl,report_features):</p>
<p>&nbsp; &nbsp;cls2 = []</p>
<p>&nbsp; &nbsp;if params['all_feats'] != "":</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;cls2 = sorted(params['all_feats'].split(":"))</p>
<p>&nbsp; &nbsp;cls = sorted(data['cls'])</p>
<p>&nbsp; &nbsp;if bcl: data['rows'].sort(key=lambda ab: math.fabs(float(ab[3]))*(cls.index(ab[2])*2-1))</p>
<p>&nbsp; &nbsp;else: &nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;mmax = max([math.fabs(float(a)) for a in zip(*data['rows'])[3]])</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;data['rows'].sort(key=lambda ab: math.fabs(float(ab[3]))/mmax+(cls.index(ab[2])+1))</p>
<p>&nbsp; &nbsp;pos = arange(len(data['rows']))</p>
<p>&nbsp; &nbsp;head = 0.75</p>
<p>&nbsp; &nbsp;tail = 0.5</p>
<p>&nbsp; &nbsp;ht = head + tail</p>
<p>&nbsp; &nbsp;ints = max(len(pos)*0.2,1.5)</p>
<p>&nbsp; &nbsp;fig = plt.figure(figsize=(params['width'], ints + ht), edgecolor=params['back_color'],facecolor=params['back_color'])</p>
<p>&nbsp; &nbsp;ax = fig.add_subplot(111,frame_on=False,facecolor=params['back_color'])</p>
<p>&nbsp; &nbsp;ls, rs = params['ls'], 1.0-params['rs']</p>
<p>&nbsp; &nbsp;plt.subplots_adjust(left=ls,right=rs,top=1-head*(1.0-ints/(ints+ht)), bottom=tail*(1.0-ints/(ints+ht)))</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp;fig.canvas.set_window_title('LDA results')</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp;l_align = {'horizontalalignment':'left', 'verticalalignment':'baseline'}</p>
<p>&nbsp; &nbsp;r_align = {'horizontalalignment':'right', 'verticalalignment':'baseline'}</p>
<p>&nbsp; &nbsp;added = []</p>
<p>&nbsp; &nbsp;m = 1 if data['rows'][0][2] == cls[0] else -1</p>
<p>&nbsp; &nbsp;out_data = defaultdict(list) # keep track of which OTUs result in the plot</p>
<p>&nbsp; &nbsp;for i,v in enumerate(data['rows']):</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;if report_features:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;otu = v[0].split('.')[7].replace('_','.') # string replace retains format New.ReferenceOTUxxx</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;score = v[3]</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;otu_class = v[2]</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;out_data[otu] = [score, otu_class]</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;indcl = cls.index(v[2])</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;lab = str(v[2]) if str(v[2]) not in added else ""</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;added.append(str(v[2])) &nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;col = colors[indcl%len(colors)] &nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;if len(cls2) &gt; 0: &nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;col = colors[cls2.index(v[2])%len(colors)]</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;vv = math.fabs(float(v[3])) * (m*(indcl*2-1)) if bcl else math.fabs(float(v[3]))</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;ax.barh(pos[i],vv, align='center', color=col, label=lab, height=0.8, edgecolor=params['fore_color'])</p>
<p>&nbsp; &nbsp;mv = max([abs(float(v[3])) for v in data['rows']]) &nbsp;</p>
<p>&nbsp; &nbsp;if report_features:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;print 'OTU\tLDA_score\tCLass'</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;for i in out_data:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print '%s\t%s\t%s' %(i, out_data[i][0], out_data[i][1])</p>
<p>&nbsp; &nbsp;for i,r in enumerate(data['rows']):</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;indcl = cls.index(data['rows'][i][2])</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;if params['n_scl'] &lt; 0: rr = r[0]</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;else: rr = ".".join(r[0].split(".")[-params['n_scl']:])</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;if len(rr) &gt; params['max_feature_len']: rr = rr[:params['max_feature_len']/2-2]+" [..]"+rr[-params['max_feature_len']/2+2:]</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;if m*(indcl*2-1) &lt; 0 and bcl: ax.text(mv/40.0,float(i)-0.3,rr, l_align, size=params['feature_font_size'],color=params['fore_color'])</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;else: ax.text(-mv/40.0,float(i)-0.3,rr, r_align, size=params['feature_font_size'],color=params['fore_color'])</p>
<p>&nbsp; &nbsp;ax.set_title(params['title'],size=params['title_font_size'],y=1.0+head*(1.0-ints/(ints+ht))*0.8,color=params['fore_color'])</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp;ax.set_yticks([])</p>
<p>&nbsp; &nbsp;ax.set_xlabel("LDA SCORE (log 10)")</p>
<p>&nbsp; &nbsp;ax.xaxis.grid(True)</p>
<p>&nbsp; &nbsp;xlim = ax.get_xlim()</p>
<p>&nbsp; &nbsp;if params['autoscale']: &nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;ran = arange(0.0001,round(round((abs(xlim[0])+abs(xlim[1]))/10,4)*100,0)/100)</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;if len(ran) &gt; 1 and len(ran) &lt; 100:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ax.set_xticks(arange(xlim[0],xlim[1]+0.0001,min(xlim[1]+0.0001,round(round((abs(xlim[0])+abs(xlim[1]))/10,4)*100,0)/100)))</p>
<p>&nbsp; &nbsp;ax.set_ylim((pos[0]-1,pos[-1]+1))</p>
<p># &nbsp; &nbsp;leg = ax.legend(bbox_to_anchor=(0.2, 1.02, 0.4, 1.102), loc=4, ncol=5, borderaxespad=0., frameon=False,prop={'size':params['class_legend_font_size']})</p>
<p>&nbsp; &nbsp;leg = ax.legend(bbox_to_anchor=(0.09, 1.0), ncol=4, borderaxespad=0., frameon=False,prop={'size':params['class_legend_font_size']})</p>
<p># &nbsp; &nbsp;leg = ax.legend(bbox_to_anchor=(0., 1.02, 1., .102), loc=3, ncol=6, borderaxespad=0., frameon=False,prop={'size':params['class_legend_font_size']})</p>
<p>&nbsp; &nbsp;def get_col_attr(x):</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return hasattr(x, 'set_color') and not hasattr(x, 'set_facecolor')</p>
<p>&nbsp; &nbsp;for o in leg.findobj(get_col_attr):</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;o.set_color(params['fore_color'])</p>
<p>&nbsp; &nbsp;for o in ax.findobj(get_col_attr):</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;o.set_color(params['fore_color'])</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp;</p>
<p>&nbsp; &nbsp;plt.savefig(path,format=params['format'],facecolor=params['back_color'],edgecolor=params['fore_color'],dpi=params['dpi'])</p>
<p>&nbsp; &nbsp;plt.close()</p>
<p>&nbsp;</p>
<p>def plot_histo_ver(path,params,data,report_features):</p>
<p>&nbsp; &nbsp;cls = data['cls']</p>
<p>&nbsp; &nbsp;mmax = max([math.fabs(float(a)) for a in zip(*data['rows'])[1]])</p>
<p>&nbsp; &nbsp;data['rows'].sort(key=lambda ab: math.fabs(float(ab[3]))/mmax+(cls.index(ab[2])+1))</p>
<p>&nbsp; &nbsp;pos = arange(len(data['rows'])) &nbsp;</p>
<p>&nbsp; &nbsp;if params['n_scl'] &lt; 0: nam = [d[0] for d in data['rows']]</p>
<p>&nbsp; &nbsp;else: nam = [d[0].split(".")[-min(d[0].count("."),params['n_scl'])] for d in data['rows']]</p>
<p>&nbsp; &nbsp;fig = plt.figure(edgecolor=params['back_color'],facecolor=params['back_color'],figsize=(params['width'], params['height'])) &nbsp;</p>
<p>&nbsp; &nbsp;ax = fig.add_subplot(111,facecolor=params['back_color'])</p>
<p>&nbsp; &nbsp;plt.subplots_adjust(top=0.9, left=params['ls'], right=params['rs'], bottom=0.3) &nbsp;</p>
<p>&nbsp; &nbsp;fig.canvas.set_window_title('LDA results') &nbsp; &nbsp;</p>
<p>&nbsp; &nbsp;l_align = {'horizontalalignment':'left', 'verticalalignment':'baseline'}</p>
<p>&nbsp; &nbsp;r_align = {'horizontalalignment':'right', 'verticalalignment':'baseline'} &nbsp;</p>
<p>&nbsp; &nbsp;added = []</p>
<p>&nbsp; &nbsp;out_data = defaultdict(list) # keep track of which OTUs result in the plot</p>
<p>&nbsp; &nbsp;for i,v in enumerate(data['rows']):</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;if report_features:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;otu = v[0].split('.')[7].replace('_','.') # string replace retains format New.ReferenceOTUxxx</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;score = v[3]</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;otu_class = v[2]</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;out_data[otu] = [score, otu_class]</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;indcl = data['cls'].index(v[2])</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;lab = str(v[2]) if str(v[2]) not in added else ""</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;added.append(str(v[2])) &nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;col = colors[indcl%len(colors)]</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;vv = math.fabs(float(v[3])) &nbsp;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;ax.bar(pos[i],vv, align='center', color=col, label=lab)</p>
<p>&nbsp; &nbsp;if report_features:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;print 'OTU\tLDA_score\tCLass'</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;for i in out_data:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print '%s\t%s\t%s' %(i, out_data[i][0], out_data[i][1])</p>
<p>&nbsp; &nbsp;xticks(pos,nam,rotation=-20, ha = 'left',size=params['feature_font_size']) &nbsp;</p>
<p>&nbsp; &nbsp;ax.set_title(params['title'],size=params['title_font_size'])</p>
<p>&nbsp; &nbsp;ax.set_ylabel("LDA SCORE (log 10)")</p>
<p>&nbsp; &nbsp;ax.yaxis.grid(True) &nbsp;</p>
<p>&nbsp; &nbsp;a,b = ax.get_xlim()</p>
<p>&nbsp; &nbsp;dx = float(len(pos))/float((b-a))</p>
<p>&nbsp; &nbsp;ax.set_xlim((0-dx,max(pos)+dx)) &nbsp;</p>
<p>&nbsp; &nbsp;plt.savefig(path,format=params['format'],facecolor=params['back_color'],edgecolor=params['fore_color'],dpi=params['dpi'])</p>
<p>&nbsp; &nbsp;plt.close() &nbsp;</p>
<p>&nbsp;</p>
<p>if __name__ == '__main__':</p>
<p>&nbsp; &nbsp;params = read_params(sys.argv)</p>
<p>&nbsp; &nbsp;params['fore_color'] = 'w' if params['back_color'] == 'k' else 'k'</p>
<p>&nbsp; &nbsp;data = read_data(params['input_file'],params['output_file'],params['otu_only'])</p>
<p>&nbsp; &nbsp;if params['orientation'] == 'v': plot_histo_ver(params['output_file'],params,data,params['report_features'])</p>
<p>&nbsp; &nbsp;else: plot_histo_hor(params['output_file'],params,data,len(data['cls']) == 2,params['report_features'])</p>
<p>&nbsp;</p>
<p>&nbsp; &nbsp;</p>
<p>&nbsp;</p>
